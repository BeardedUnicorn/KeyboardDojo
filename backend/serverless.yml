service: keyboard-dojo

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  environment:
    STAGE: ${self:provider.stage}
    USERS_TABLE: ${self:service}-${self:provider.stage}-users
    LESSONS_TABLE: ${self:service}-${self:provider.stage}-lessons
    PROGRESS_TABLE: ${self:service}-${self:provider.stage}-progress
    SUBSCRIPTIONS_TABLE: ${self:service}-${self:provider.stage}-subscriptions
    JWT_SECRET: ${self:custom.secrets.JWT_SECRET}
    GOOGLE_CLIENT_ID: ${self:custom.secrets.GOOGLE_CLIENT_ID}
    GOOGLE_CLIENT_SECRET: ${self:custom.secrets.GOOGLE_CLIENT_SECRET}
    GITHUB_CLIENT_ID: ${self:custom.secrets.GITHUB_CLIENT_ID}
    GITHUB_CLIENT_SECRET: ${self:custom.secrets.GITHUB_CLIENT_SECRET}
    APPLE_CLIENT_ID: ${self:custom.secrets.APPLE_CLIENT_ID}
    APPLE_CLIENT_SECRET: ${self:custom.secrets.APPLE_CLIENT_SECRET}
    CLIENT_URL: ${self:custom.clientUrl}
    STRIPE_SECRET_KEY: ${self:custom.secrets.STRIPE_SECRET_KEY}
    STRIPE_WEBHOOK_SECRET: ${self:custom.secrets.STRIPE_WEBHOOK_SECRET}
    PRICE_MONTHLY: ${self:custom.secrets.PRICE_MONTHLY}
    PRICE_ANNUAL: ${self:custom.secrets.PRICE_ANNUAL}
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:BatchWriteItem
      Resource:
        - !GetAtt UsersTable.Arn
        - !GetAtt LessonsTable.Arn
        - !GetAtt ProgressTable.Arn
        - !GetAtt SubscriptionsTable.Arn
        - !Sub "${UsersTable.Arn}/index/*"
        - !Sub "${LessonsTable.Arn}/index/*"
        - !Sub "${ProgressTable.Arn}/index/*"
        - !Sub "${SubscriptionsTable.Arn}/index/*"
    # Add S3 permissions for frontend deployment
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:GetObject
        - s3:ListBucket
        - s3:DeleteObject
      Resource:
        - !GetAtt WebAppBucket.Arn
        - !Join ['', [!GetAtt WebAppBucket.Arn, '/*']]

plugins:
  - serverless-plugin-typescript
  - serverless-offline

custom:
  # Specify the frontend build path
  frontendBuildPath: '../frontend/dist'
  # Client URL for CORS and redirects
  clientUrl: ${opt:clientUrl, 'http://localhost:5173'}
  # Secrets (would be environment variables or SSM parameters in a real deployment)
  secrets:
    JWT_SECRET: ${env:JWT_SECRET, 'your-jwt-secret-for-keyboard-dojo-dev'}
    GOOGLE_CLIENT_ID: ${env:GOOGLE_CLIENT_ID, ''}
    GOOGLE_CLIENT_SECRET: ${env:GOOGLE_CLIENT_SECRET, ''}
    GITHUB_CLIENT_ID: ${env:GITHUB_CLIENT_ID, ''}
    GITHUB_CLIENT_SECRET: ${env:GITHUB_CLIENT_SECRET, ''}
    APPLE_CLIENT_ID: ${env:APPLE_CLIENT_ID, ''}
    APPLE_CLIENT_SECRET: ${env:APPLE_CLIENT_SECRET, ''}
    STRIPE_SECRET_KEY: ${env:STRIPE_SECRET_KEY, ''}
    STRIPE_WEBHOOK_SECRET: ${env:STRIPE_WEBHOOK_SECRET, ''}
    PRICE_MONTHLY: ${env:PRICE_MONTHLY, ''}
    PRICE_ANNUAL: ${env:PRICE_ANNUAL, ''}

package:
  individually: true
  excludeDevDependencies: true

functions:
  healthCheck:
    handler: src/functions/healthCheck.handler
    events:
      - http:
          path: /health
          method: get
          cors: true

  # Build and deploy frontend 
  deployFrontend:
    handler: src/functions/deployFrontend.handler
    timeout: 300 # 5 minutes
    environment:
      WEB_APP_BUCKET: !Ref WebAppBucket
      CLOUDFRONT_DISTRIBUTION_ID: !Ref CloudFrontDistribution

  # Authentication endpoints
  register:
    handler: src/functions/auth/register.handler
    events:
      - http:
          path: /auth/register
          method: post
          cors: true

  login:
    handler: src/functions/auth/login.handler
    events:
      - http:
          path: /auth/login
          method: post
          cors: true

  verifyToken:
    handler: src/functions/auth/verifyToken.handler
    events:
      - http:
          path: /auth/verify
          method: get
          cors: true

  # OAuth Endpoints
  googleAuth:
    handler: src/functions/auth/oauth/google.handler
    events:
      - http:
          path: /auth/google/callback
          method: post
          cors: true

  githubAuth:
    handler: src/functions/auth/oauth/github.handler
    events:
      - http:
          path: /auth/github/callback
          method: post
          cors: true

  appleAuth:
    handler: src/functions/auth/oauth/apple.handler
    events:
      - http:
          path: /auth/apple/callback
          method: post
          cors: true

  # Lesson endpoints
  getAllLessons:
    handler: src/functions/lessons/getAllLessons.handler
    events:
      - http:
          path: /lessons
          method: get
          cors: true

  getLessonById:
    handler: src/functions/lessons/getLessonById.handler
    events:
      - http:
          path: /lessons/{id}
          method: get
          cors: true

  getLessonsByCategory:
    handler: src/functions/lessons/getLessonsByCategory.handler
    events:
      - http:
          path: /lessons/category/{category}
          method: get
          cors: true

  # Progress endpoints
  getUserProgress:
    handler: src/functions/progress/getUserProgress.handler
    events:
      - http:
          path: /progress
          method: get
          cors: true
          authorizer:
            name: verifyToken
            identitySource: method.request.header.Authorization
            type: token

  updateUserProgress:
    handler: src/functions/progress/updateUserProgress.handler
    events:
      - http:
          path: /progress
          method: post
          cors: true
          authorizer:
            name: verifyToken
            identitySource: method.request.header.Authorization
            type: token

  # Subscription endpoints
  createCheckoutSession:
    handler: src/functions/subscriptions/createCheckoutSession.handler
    events:
      - http:
          path: /subscriptions/checkout
          method: post
          cors: true
          authorizer:
            name: verifyToken
            identitySource: method.request.header.Authorization
            type: token

  getUserSubscription:
    handler: src/functions/subscriptions/getUserSubscription.handler
    events:
      - http:
          path: /subscriptions
          method: get
          cors: true
          authorizer:
            name: verifyToken
            identitySource: method.request.header.Authorization
            type: token

  cancelSubscription:
    handler: src/functions/subscriptions/cancelSubscription.handler
    events:
      - http:
          path: /subscriptions/cancel
          method: post
          cors: true
          authorizer:
            name: verifyToken
            identitySource: method.request.header.Authorization
            type: token

  stripeWebhook:
    handler: src/functions/subscriptions/stripeWebhook.handler
    events:
      - http:
          path: /webhooks/stripe
          method: post
          cors: true

  # Admin functions
  seedLessons:
    handler: src/functions/admin/seedLessons.handler
    events:
      - http:
          path: /admin/seed-lessons
          method: post
          cors: true
          authorizer:
            name: verifyToken
            identitySource: method.request.header.Authorization
            type: token

resources:
  Resources:
    # DynamoDB Tables
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-users
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: EmailIndex
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        # Schema attributes (not part of CloudFormation but conceptual):
        # - userId: String (primary key)
        # - email: String (GSI key)
        # - name: String
        # - authProvider: String (google, apple, github, email)
        # - providerId: String (ID from provider if OAuth)
        # - hashedPassword: String (for email auth)
        # - createdAt: Number (timestamp)
        # - isAdmin: Boolean
        # - isPremium: Boolean (for premium subscription)
        # - stripeCustomerId: String (Stripe customer ID)

    LessonsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-lessons
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: lessonId
            AttributeType: S
          - AttributeName: category
            AttributeType: S
        KeySchema:
          - AttributeName: lessonId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: CategoryIndex
            KeySchema:
              - AttributeName: category
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        # Schema attributes (conceptual):
        # - lessonId: String (primary key)
        # - title: String
        # - description: String
        # - category: String (GSI key)
        # - difficulty: String (beginner, intermediate, advanced)
        # - order: Number
        # - content: Object
        #   - introduction: String
        #   - shortcuts: Array of Shortcut objects
        #     - id: String
        #     - name: String
        #     - description: String
        #     - keyCombination: Array of String
        #     - operatingSystem: String (optional)
        #     - context: String (optional)
        #   - tips: Array of String
        # - isPremium: Boolean
        # - createdAt: Number (timestamp)
        # - updatedAt: Number (timestamp)

    ProgressTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-progress
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        # Schema attributes (conceptual):
        # - userId: String (primary key)
        # - completedLessons: Map of LessonCompletion objects
        #   - [lessonId]: Object
        #     - completedAt: Number (timestamp)
        #     - score: Number
        #     - attempts: Number
        #     - timeSpent: Number (seconds)
        #     - shortcuts: Map of ShortcutProgress objects
        #       - [shortcutId]: Object
        #         - mastered: Boolean
        #         - attempts: Number
        #         - correctAttempts: Number
        #         - lastAttemptAt: Number (timestamp)
        # - totalLessonsCompleted: Number
        # - streakDays: Number
        # - lastActivityDate: Number (timestamp)
        # - updatedAt: Number (timestamp)
    
    SubscriptionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-subscriptions
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: userId
            AttributeType: S
          - AttributeName: stripeSubscriptionId
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: ByUserId
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: ByStripeSubscriptionId
            KeySchema:
              - AttributeName: stripeSubscriptionId
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        # Schema attributes (conceptual):
        # - id: String (primary key - unique subscription ID)
        # - userId: String (GSI key - user who owns the subscription)
        # - stripeCustomerId: String (Stripe customer ID)
        # - stripeSubscriptionId: String (GSI key - Stripe subscription ID)
        # - plan: String (monthly, annual)
        # - status: String (active, cancelled, past_due, etc.)
        # - currentPeriodStart: Number (timestamp)
        # - currentPeriodEnd: Number (timestamp)
        # - cancelAtPeriodEnd: Boolean
        # - createdAt: Number (timestamp)
        # - updatedAt: Number (timestamp)

    # CloudFront and S3 for frontend hosting
    WebAppBucket:
      Type: AWS::S3::Bucket
      Properties:
        AccessControl: Private
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders: ['*']
              AllowedMethods: [GET]
              AllowedOrigins: ['*']
              MaxAge: 3000

    WebAppBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref WebAppBucket
        PolicyDocument:
          Statement:
            - Action: s3:GetObject
              Effect: Allow
              Resource: !Join ['', [!GetAtt WebAppBucket.Arn, '/*']]
              Principal:
                CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId

    CloudFrontOriginAccessIdentity:
      Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment: OAI for Keyboard Dojo Web App

    CloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Origins:
            - DomainName: !GetAtt WebAppBucket.DomainName
              Id: S3Origin
              S3OriginConfig:
                OriginAccessIdentity: !Join ['', ['origin-access-identity/cloudfront/', !Ref CloudFrontOriginAccessIdentity]]
          Enabled: true
          DefaultRootObject: index.html
          CustomErrorResponses:
            - ErrorCode: 404
              ResponseCode: 200
              ResponsePagePath: /index.html
            - ErrorCode: 403
              ResponseCode: 200
              ResponsePagePath: /index.html
          DefaultCacheBehavior:
            AllowedMethods: [GET, HEAD, OPTIONS]
            TargetOriginId: S3Origin
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
            ViewerProtocolPolicy: redirect-to-https
          PriceClass: PriceClass_100
          ViewerCertificate:
            CloudFrontDefaultCertificate: true

  Outputs:
    CloudFrontDistributionDomainName:
      Description: The domain name of the CloudFront distribution
      Value: !GetAtt CloudFrontDistribution.DomainName

    WebAppBucketName:
      Description: The name of the S3 bucket for the web app
      Value: !Ref WebAppBucket 